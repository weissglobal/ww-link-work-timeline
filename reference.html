<!--
  Timeline Planning Component v2 — WeWeb HTML Embed

  WeWeb IDs:
    filterCategory  = 39d971ee-2f55-4357-8874-e315154426f1
    selectedDate    = 7d3478eb-061c-4ce9-8180-a79cbf1e66ea
    selectedTaskId  = 5c604db6-71f2-4645-b405-2e714602c20d
    viewMode        = dfd9aee9-ad5d-4506-b2f3-3b8eaa670440
    zoom            = 15c65d0b-fa5a-4a2b-b4cb-81d70a00c14b
    tasks (coll.)   = 1a4c2626-e7ef-4344-9efe-e790a812e52f

  Workflow placeholders:
    updateTaskSchedule = __WORKFLOW_UPDATE_TASK_SCHEDULE__
    openTaskDetail     = __WORKFLOW_OPEN_TASK_DETAIL__
-->

<div id="tlRoot">
  <!-- Header -->
  <div id="tlHeader" class="tl-header">
    <div class="tl-header-left">
      <button class="tl-nav-btn" id="tlPrevDay">&#8249;</button>
      <div class="tl-date-display" id="tlDateDisplay"></div>
      <button class="tl-nav-btn" id="tlNextDay">&#8250;</button>
      <div class="tl-tabs" id="tlTabs">
        <button class="tl-tab active" data-view="today">Heute</button>
        <button class="tl-tab" data-view="tomorrow">Morgen</button>
        <button class="tl-tab" data-view="week">Woche</button>
        <button class="tl-tab" data-view="backlog">Backlog</button>
      </div>
    </div>
    <div class="tl-header-right">
      <div class="tl-filters" id="tlFilters"></div>
      <div class="tl-zoom-controls">
        <button class="tl-zoom-btn" id="tlZoomOut">&#8722;</button>
        <span class="tl-zoom-label" id="tlZoomLabel">100%</span>
        <button class="tl-zoom-btn" id="tlZoomIn">&#43;</button>
      </div>
    </div>
  </div>

  <!-- Day view -->
  <div class="tl-body" id="tlDayView">
    <div class="tl-members" id="tlMembers"></div>
    <div class="tl-grid-wrapper" id="tlGridWrapper">
      <div class="tl-grid" id="tlGrid">
        <div class="tl-hour-headers" id="tlHourHeaders"></div>
        <div id="tlGridRows"></div>
      </div>
    </div>
  </div>

  <!-- Week view -->
  <div class="tl-body" id="tlWeekView" style="display:none; flex-direction:column;">
    <div class="tl-week-header" id="tlWeekHeader"></div>
    <div class="tl-week-grid" id="tlWeekGrid" style="flex:1; overflow-y:auto;"></div>
  </div>

  <!-- Backlog view -->
  <div class="tl-backlog" id="tlBacklogView" style="display:none;"></div>

  <!-- Tooltip -->
  <div class="tl-tooltip" id="tlTooltip">
    <div class="tl-tooltip-title" id="tlTooltipTitle"></div>
    <div id="tlTooltipBody"></div>
  </div>
</div>

<style>
/* ── Reset ──────────────────────────────────────────── */
#tlRoot *, #tlRoot *::before, #tlRoot *::after { box-sizing:border-box; margin:0; padding:0; }
#tlRoot {
  --bg:#0b0d12; --bg-card:#161920; --bg-card-hover:#1c2029;
  --bg-surface:#1a1d25; --bg-row-alt:#12141a;
  --border:#232732; --border-light:#1e2230;
  --text:#e2e4ea; --text-muted:#8b8fa3; --text-dim:#575b6e;
  --accent:#3b82f6; --accent-hover:#2563eb; --accent-dim:rgba(59,130,246,0.15);
  --red:#ef4444; --orange:#f97316; --purple:#a855f7;
  --green:#22c55e; --yellow:#eab308; --cyan:#06b6d4; --pink:#ec4899;

  font-family:'Inter',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:var(--bg); color:var(--text);
  width:100%; height:100%;
  display:flex; flex-direction:column; overflow:hidden;
  font-size:13px; line-height:1.4;
  user-select:none; -webkit-font-smoothing:antialiased;
  position:relative;
}

/* ── Header ─────────────────────────────────────────── */
.tl-header { display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--bg-card); flex-shrink:0; min-height:52px; }
.tl-header-left { display:flex; align-items:center; gap:12px; }
.tl-header-right { display:flex; align-items:center; gap:8px; margin-left:auto; }
.tl-date-display { font-size:14px; font-weight:600; color:var(--text); white-space:nowrap; }
.tl-date-display span { color:var(--text-muted); font-weight:400; }

.tl-tabs { display:flex; gap:2px; background:var(--bg); border-radius:8px; padding:2px; }
.tl-tab { padding:6px 14px; border-radius:6px; font-size:12px; font-weight:500; color:var(--text-muted); cursor:pointer; white-space:nowrap; border:none; background:none; transition:all .15s; }
.tl-tab:hover { color:var(--text); background:var(--bg-card); }
.tl-tab.active { color:var(--text); background:var(--bg-card); box-shadow:0 1px 3px rgba(0,0,0,.3); }

.tl-filters { display:flex; gap:4px; align-items:center; }
.tl-filter-pill { padding:4px 10px; border-radius:6px; font-size:11px; font-weight:500; color:var(--text-muted); cursor:pointer; border:1px solid transparent; background:none; white-space:nowrap; transition:all .15s; }
.tl-filter-pill:hover { color:var(--text); border-color:var(--border); }
.tl-filter-pill.active { color:var(--accent); border-color:var(--accent); background:var(--accent-dim); }

.tl-zoom-controls { display:flex; align-items:center; gap:4px; }
.tl-zoom-btn { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:6px; background:var(--bg-surface); border:1px solid var(--border); color:var(--text-muted); cursor:pointer; font-size:14px; transition:all .15s; }
.tl-zoom-btn:hover { color:var(--text); border-color:var(--text-muted); }
.tl-zoom-label { font-size:11px; color:var(--text-dim); min-width:32px; text-align:center; }

.tl-nav-btn { width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:var(--bg-surface); border:1px solid var(--border); color:var(--text-muted); cursor:pointer; font-size:16px; transition:all .15s; }
.tl-nav-btn:hover { color:var(--text); border-color:var(--text-muted); }

/* ── Body / Grid ────────────────────────────────────── */
.tl-body { flex:1; display:flex; overflow:hidden; position:relative; }

.tl-members { width:200px; min-width:200px; flex-shrink:0; border-right:1px solid var(--border); overflow-y:auto; background:var(--bg-card); z-index:10; }
.tl-members::-webkit-scrollbar { display:none; }
.tl-member-header { height:40px; display:flex; align-items:center; padding:0 14px; font-size:11px; font-weight:600; color:var(--text-dim); text-transform:uppercase; letter-spacing:.05em; border-bottom:1px solid var(--border); background:var(--bg-card); position:sticky; top:0; z-index:2; }
.tl-member-row { height:64px; display:flex; align-items:center; gap:10px; padding:0 14px; border-bottom:1px solid var(--border-light); transition:background .1s; }
.tl-member-row:nth-child(even) { background:var(--bg-row-alt); }
.tl-member-row:hover { background:var(--bg-card-hover); }
.tl-member-row.drop-target { background:rgba(59,130,246,.08); }

.tl-avatar { width:32px; height:32px; border-radius:50%; background:var(--bg-surface); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; color:var(--text-muted); flex-shrink:0; overflow:hidden; border:2px solid var(--border); }
.tl-avatar img { width:100%; height:100%; object-fit:cover; }
.tl-member-info { overflow:hidden; }
.tl-member-name { font-size:13px; font-weight:500; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.tl-member-role { font-size:11px; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.tl-grid-wrapper { flex:1; overflow-x:auto; overflow-y:auto; position:relative; }
.tl-grid-wrapper::-webkit-scrollbar { height:8px; width:8px; }
.tl-grid-wrapper::-webkit-scrollbar-track { background:var(--bg); }
.tl-grid-wrapper::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }
.tl-grid { position:relative; min-height:100%; }

.tl-hour-headers { display:flex; height:40px; position:sticky; top:0; z-index:5; background:var(--bg-card); border-bottom:1px solid var(--border); }
.tl-hour-header { display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:500; color:var(--text-dim); border-right:1px solid var(--border-light); flex-shrink:0; }
.tl-hour-header.current { color:var(--accent); font-weight:600; }

.tl-grid-row { height:64px; position:relative; border-bottom:1px solid var(--border-light); }
.tl-grid-row:nth-child(even) { background:var(--bg-row-alt); }

.tl-grid-line { position:absolute; top:0; bottom:0; width:1px; background:var(--border-light); z-index:0; }
.tl-grid-line.hour { background:var(--border); }

.tl-now-line { position:absolute; top:0; bottom:0; width:2px; background:var(--red); z-index:15; pointer-events:none; }
.tl-now-line::before { content:''; position:absolute; top:-1px; left:-4px; width:10px; height:10px; background:var(--red); border-radius:50%; }

/* ── Task Blocks ────────────────────────────────────── */
.tl-task { position:absolute; top:6px; height:calc(100% - 12px); border-radius:6px; cursor:grab; display:flex; align-items:center; gap:6px; padding:0 8px; font-size:11px; font-weight:500; color:#fff; overflow:hidden; z-index:10; transition:box-shadow .15s,transform .1s; border:1px solid rgba(255,255,255,.08); }
.tl-task:hover { box-shadow:0 4px 12px rgba(0,0,0,.4); transform:translateY(-1px); z-index:20; }
.tl-task.dragging { opacity:.85; cursor:grabbing; box-shadow:0 8px 24px rgba(0,0,0,.5); z-index:100; }
.tl-task.selected { box-shadow:0 0 0 2px var(--accent),0 4px 12px rgba(0,0,0,.4); z-index:25; }
.tl-task-priority { width:3px; height:60%; border-radius:2px; flex-shrink:0; }
.tl-task-content { overflow:hidden; flex:1; min-width:0; }
.tl-task-title { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:11px; font-weight:500; line-height:1.3; }
.tl-task-meta { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:10px; opacity:.7; line-height:1.3; }
.tl-task-duration { font-size:10px; opacity:.6; flex-shrink:0; white-space:nowrap; }

/* ── Empty ──────────────────────────────────────────── */
.tl-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:48px 24px; text-align:center; gap:8px; }
.tl-empty-icon { font-size:32px; opacity:.5; }
.tl-empty-text { font-size:14px; color:var(--text-muted); }
.tl-empty-sub { font-size:12px; color:var(--text-dim); }

/* ── Backlog ────────────────────────────────────────── */
.tl-backlog { flex:1; overflow-y:auto; padding:16px; display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:8px; align-content:start; }
.tl-backlog-card { background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:12px; cursor:pointer; transition:all .15s; display:flex; gap:10px; align-items:flex-start; }
.tl-backlog-card:hover { border-color:var(--text-dim); background:var(--bg-card-hover); }
.tl-backlog-priority { width:4px; height:100%; min-height:36px; border-radius:2px; flex-shrink:0; }
.tl-backlog-content { flex:1; min-width:0; }
.tl-backlog-title { font-size:13px; font-weight:500; color:var(--text); margin-bottom:4px; }
.tl-backlog-detail { font-size:11px; color:var(--text-dim); display:flex; gap:8px; flex-wrap:wrap; }
.tl-backlog-badge { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:500; color:rgba(255,255,255,.85); }

/* ── Week ───────────────────────────────────────────── */
.tl-week-header { display:flex; height:48px; position:sticky; top:0; z-index:5; background:var(--bg-card); border-bottom:1px solid var(--border); }
.tl-week-day-header { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:11px; color:var(--text-dim); border-right:1px solid var(--border-light); cursor:pointer; transition:background .15s; }
.tl-week-day-header:hover { background:var(--bg-card-hover); }
.tl-week-day-header.today { color:var(--accent); font-weight:600; background:var(--accent-dim); }
.tl-week-day-header .day-name { font-size:10px; text-transform:uppercase; letter-spacing:.05em; }
.tl-week-day-header .day-num { font-size:16px; font-weight:600; }
.tl-week-grid { display:flex; flex:1; }
.tl-week-column { flex:1; border-right:1px solid var(--border-light); padding:4px; display:flex; flex-direction:column; gap:4px; min-height:100%; }
.tl-week-task { background:var(--bg-card); border:1px solid var(--border); border-left:3px solid var(--accent); border-radius:6px; padding:8px; cursor:pointer; transition:all .15s; font-size:11px; }
.tl-week-task:hover { border-color:var(--text-dim); background:var(--bg-card-hover); }
.tl-week-task-title { font-weight:500; color:var(--text); margin-bottom:2px; }
.tl-week-task-time { font-size:10px; color:var(--text-dim); }
.tl-week-task-assignee { font-size:10px; color:var(--text-dim); margin-top:2px; }

/* ── Tooltip ────────────────────────────────────────── */
.tl-tooltip { position:absolute; z-index:1000; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:10px 12px; font-size:12px; box-shadow:0 8px 24px rgba(0,0,0,.5); pointer-events:none; opacity:0; transition:opacity .15s; max-width:260px; display:none; }
.tl-tooltip.visible { opacity:1; display:block; }
.tl-tooltip-title { font-weight:600; color:var(--text); margin-bottom:4px; }
.tl-tooltip-row { color:var(--text-muted); font-size:11px; line-height:1.6; }
.tl-tooltip-row strong { color:var(--text); font-weight:500; }
</style>

<script>
(function(){
  /* ──────────────────────────────────────────────────────
     SCOPE: Find our own root element. In WeWeb HTML Embed
     the script runs in the same document context as the
     embed's HTML, so getElementById works — but we scope
     all queries to our root to avoid collisions.
     ────────────────────────────────────────────────────── */
  var ROOT = null;

  function $(id) {
    if (!ROOT) return null;
    return ROOT.querySelector('#' + id) || ROOT.querySelector('.' + id);
  }
  function $id(id) {
    if (!ROOT) return null;
    // Try within our root first
    var el = ROOT.querySelector('#' + id);
    if (el) return el;
    // Fallback to document level
    return document.getElementById(id);
  }
  function $$(sel) {
    if (!ROOT) return [];
    return Array.prototype.slice.call(ROOT.querySelectorAll(sel));
  }

  /* ── WeWeb Integration ─────────────────────────────── */
  var WW = {
    vars: {
      filterCategory:  '39d971ee-2f55-4357-8874-e315154426f1',
      selectedDate:    '7d3478eb-061c-4ce9-8180-a79cbf1e66ea',
      selectedTaskId:  '5c604db6-71f2-4645-b405-2e714602c20d',
      viewMode:        'dfd9aee9-ad5d-4506-b2f3-3b8eaa670440',
      zoom:            '15c65d0b-fa5a-4a2b-b4cb-81d70a00c14b'
    },
    collections: { tasks: '1a4c2626-e7ef-4344-9efe-e790a812e52f' },
    workflows: {
      updateTaskSchedule: '__WORKFLOW_UPDATE_TASK_SCHEDULE__',
      openTaskDetail:     '__WORKFLOW_OPEN_TASK_DETAIL__'
    }
  };

  function wwGet(key) {
    try {
      if (typeof wwLib === 'undefined' || !wwLib.wwVariable) return null;
      return wwLib.wwVariable.getValue(WW.vars[key]);
    } catch(e) { return null; }
  }
  function wwSet(key, val) {
    try {
      if (typeof wwLib === 'undefined' || !wwLib.wwVariable) return;
      wwLib.wwVariable.setValue(WW.vars[key], val);
    } catch(e) {}
  }
  function wwCollection(key) {
    try {
      if (typeof wwLib === 'undefined') return null;
      /* WeWeb exposes collections differently depending on version */
      var data = null;
      if (wwLib.wwCollection && wwLib.wwCollection.getCollectionData) {
        data = wwLib.wwCollection.getCollectionData(WW.collections[key]);
      }
      if (!data && wwLib.$store) {
        var col = wwLib.$store.getters['data/getCollection'](WW.collections[key]);
        if (col && col.data) data = col.data;
      }
      return data && Array.isArray(data) && data.length > 0 ? data : null;
    } catch(e) { return null; }
  }
  function wwWorkflow(key, params) {
    try {
      var id = WW.workflows[key];
      if (!id || id.indexOf('__') === 0) return;
      if (typeof wwLib !== 'undefined' && wwLib.executeWorkflow) {
        wwLib.executeWorkflow(id, params);
      }
    } catch(e) {}
  }

  /* ── Constants ─────────────────────────────────────── */
  var H_START = 7, H_END = 20, H_COUNT = H_END - H_START;

  var CAT_LABELS = {
    design:'Design', development:'Development', content:'Content', seo:'SEO',
    advertising:'Ads', social_media:'Social', consulting:'Beratung',
    project_management:'PM', analytics:'Analytics', qa:'QA', admin:'Admin',
    sales:'Sales', customer_success:'CS', bookkeeping:'Buchhaltung',
    tax:'Steuer', other:'Sonstige'
  };
  var CAT_COLORS = {
    design:'#7c3aed', development:'#2563eb', content:'#0891b2', seo:'#059669',
    advertising:'#d97706', social_media:'#db2777', consulting:'#7c3aed',
    project_management:'#6366f1', analytics:'#0d9488', qa:'#ea580c',
    admin:'#64748b', sales:'#16a34a', customer_success:'#0891b2',
    bookkeeping:'#ca8a04', tax:'#9f1239', other:'#6b7280'
  };
  var PRIO_COLORS = { urgent:'#3b82f6', high:'#ef4444', medium:'#a855f7', low:'#22c55e' };
  var DAYS = ['So','Mo','Di','Mi','Do','Fr','Sa'];
  var MONTHS = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];

  /* ── State ─────────────────────────────────────────── */
  var S = {
    view: 'today',
    date: new Date(),
    filter: 'all',
    zoom: 120,
    selTask: null,
    tasks: [],
    members: [],
    drag: null
  };

  /* ── Mock Data ─────────────────────────────────────── */
  var MOCK = [
    { id:'t1', title:'Hero Section finalisieren', priority:'urgent', assigned_to:'m1', scheduled_start_time:'08:00:00', scheduled_end_time:'10:00:00', project_name:'Website Relaunch', project_color:'#3b82f6', client_name:'MeerWert', category:'design', estimated_minutes:120, assignee_name:'Alex Weber', assignee_avatar:null },
    { id:'t2', title:'API Integration testen', priority:'high', assigned_to:'m2', scheduled_start_time:'09:00:00', scheduled_end_time:'11:30:00', project_name:'App Projekt', project_color:'#f97316', client_name:'terraluma', category:'development', estimated_minutes:150, assignee_name:'Sarah Koch', assignee_avatar:null },
    { id:'t3', title:'Sprint Planning vorbereiten', priority:'medium', assigned_to:'m3', scheduled_start_time:'10:00:00', scheduled_end_time:'11:00:00', project_name:null, project_color:null, client_name:null, category:'project_management', estimated_minutes:60, assignee_name:'Max Bauer', assignee_avatar:null },
    { id:'t4', title:'Social Media Assets', priority:'low', assigned_to:'m1', scheduled_start_time:'11:00:00', scheduled_end_time:'12:30:00', project_name:'Website Relaunch', project_color:'#3b82f6', client_name:'MeerWert', category:'design', estimated_minutes:90, assignee_name:'Alex Weber', assignee_avatar:null },
    { id:'t5', title:'Bug Fixes Checkout', priority:'high', assigned_to:'m2', scheduled_start_time:'13:00:00', scheduled_end_time:'15:00:00', project_name:'App Projekt', project_color:'#f97316', client_name:'terraluma', category:'development', estimated_minutes:120, assignee_name:'Sarah Koch', assignee_avatar:null },
    { id:'t6', title:'Client-Call Notizen aufbereiten', priority:'low', assigned_to:'m3', scheduled_start_time:'14:00:00', scheduled_end_time:'14:30:00', project_name:null, project_color:null, client_name:'terraluma', category:'admin', estimated_minutes:30, assignee_name:'Max Bauer', assignee_avatar:null }
  ];

  /* ── Helpers ───────────────────────────────────────── */
  function t2d(s){ if(!s)return 0; var p=s.split(':'); return parseInt(p[0],10)+(parseInt(p[1]||0,10)/60); }
  function d2t(d){ var h=Math.floor(d),m=Math.round((d-h)*60); return (h<10?'0':'')+h+':'+(m<10?'0':'')+m; }
  function fmtDate(d){ return DAYS[d.getDay()]+', '+d.getDate()+'. '+MONTHS[d.getMonth()]+' '+d.getFullYear(); }
  function toDS(d){ var m=d.getMonth()+1,dy=d.getDate(); return d.getFullYear()+'-'+(m<10?'0':'')+m+'-'+(dy<10?'0':'')+dy; }
  function parseDS(s){ var p=s.split('-'); return new Date(+p[0],+p[1]-1,+p[2]); }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate(); }
  function initials(n){ if(!n)return'?'; return n.split(' ').map(function(w){return w[0]}).join('').toUpperCase().slice(0,2); }
  function taskColor(t){ return t.project_color || CAT_COLORS[t.category] || '#6b7280'; }
  function weekNum(d){ var dt=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); var dn=dt.getUTCDay()||7; dt.setUTCDate(dt.getUTCDate()+4-dn); var ys=new Date(Date.UTC(dt.getUTCFullYear(),0,1)); return Math.ceil((((dt-ys)/864e5)+1)/7); }

  /* ── Data ──────────────────────────────────────────── */
  function loadData(){
    var ww = wwCollection('tasks');
    S.tasks = (ww && ww.length) ? ww : MOCK;

    var map = {};
    S.tasks.forEach(function(t){
      if(t.assigned_to && !map[t.assigned_to]){
        map[t.assigned_to] = {
          id: t.assigned_to,
          name: t.assignee_name || 'Unbekannt',
          avatar: t.assignee_avatar || null,
          role: t.category ? (CAT_LABELS[t.category]||t.category) : ''
        };
      }
    });
    var arr = []; for(var k in map) arr.push(map[k]);
    S.members = arr.length ? arr : [
      {id:'m1',name:'Alex Weber',avatar:null,role:'Design'},
      {id:'m2',name:'Sarah Koch',avatar:null,role:'Development'},
      {id:'m3',name:'Max Bauer',avatar:null,role:'PM'}
    ];

    var v;
    v=wwGet('viewMode');    if(v) S.view=v;
    v=wwGet('selectedDate');if(v) S.date=parseDS(v);
    v=wwGet('filterCategory');if(v) S.filter=v;
    v=wwGet('zoom');        if(v) S.zoom=+v;
    v=wwGet('selectedTaskId');if(v) S.selTask=v;
  }

  function filtered(){
    var t=S.tasks;
    if(S.filter && S.filter!=='all') t=t.filter(function(x){return x.category===S.filter});
    return t;
  }
  function scheduled(){ return filtered().filter(function(t){return t.scheduled_start_time && t.scheduled_end_time}); }
  function backlog()  { return filtered().filter(function(t){return !t.scheduled_start_time || !t.scheduled_end_time}); }

  /* ── Render Header ─────────────────────────────────── */
  function renderHeader(){
    var el=$id('tlDateDisplay');
    if(!el) return;
    if(S.view==='week'){
      var mon=new Date(S.date); mon.setDate(mon.getDate()-((mon.getDay()+6)%7));
      var fri=new Date(mon); fri.setDate(mon.getDate()+4);
      el.innerHTML='<strong>KW '+weekNum(S.date)+'</strong> <span>'+mon.getDate()+'. '+MONTHS[mon.getMonth()].slice(0,3)+' – '+fri.getDate()+'. '+MONTHS[fri.getMonth()].slice(0,3)+' '+fri.getFullYear()+'</span>';
    } else if(S.view==='backlog'){
      el.innerHTML='<strong>Backlog</strong> <span>Ungeplante Tasks</span>';
    } else {
      el.innerHTML='<strong>'+fmtDate(S.date)+'</strong>';
    }
    $$('.tl-tab').forEach(function(t){ t.classList.toggle('active', t.getAttribute('data-view')===S.view); });
    var zl=$id('tlZoomLabel'); if(zl) zl.textContent=Math.round(S.zoom/1.2)+'%';
  }

  function renderFilters(){
    var el=$id('tlFilters'); if(!el)return;
    var cats={}; S.tasks.forEach(function(t){if(t.category)cats[t.category]=1;});
    var keys=['all']; for(var k in cats) keys.push(k); keys.sort();
    el.innerHTML=keys.map(function(c){
      var label = c==='all'?'Alle':(CAT_LABELS[c]||c);
      return '<button class="tl-filter-pill'+(S.filter===c?' active':'')+'" data-cat="'+c+'">'+label+'</button>';
    }).join('');
  }

  /* ── Render Day View ───────────────────────────────── */
  function renderDay(){
    var dayV=$id('tlDayView'), weekV=$id('tlWeekView'), blV=$id('tlBacklogView');
    if(dayV) dayV.style.display='flex';
    if(weekV) weekV.style.display='none';
    if(blV)  blV.style.display='none';

    var tasks=scheduled(), gw=H_COUNT*S.zoom;

    // Hours
    var hdr=$id('tlHourHeaders');
    if(hdr){
      var hh='', nowH=new Date().getHours();
      for(var h=H_START;h<H_END;h++){
        var cur=(h===nowH && sameDay(S.date,new Date()))?' current':'';
        hh+='<div class="tl-hour-header'+cur+'" style="width:'+S.zoom+'px">'+(h<10?'0':'')+h+':00</div>';
      }
      hdr.innerHTML=hh;
    }

    // Members
    var mem=$id('tlMembers');
    if(mem){
      var mh='<div class="tl-member-header">Team</div>';
      S.members.forEach(function(m){
        var av=m.avatar?'<img src="'+m.avatar+'" alt="">':initials(m.name);
        mh+='<div class="tl-member-row" data-mid="'+m.id+'"><div class="tl-avatar">'+av+'</div><div class="tl-member-info"><div class="tl-member-name">'+m.name+'</div><div class="tl-member-role">'+(m.role||'')+'</div></div></div>';
      });
      mem.innerHTML=mh;
    }

    // Grid rows
    var gr=$id('tlGridRows');
    if(gr){
      var rh='';
      S.members.forEach(function(m,mi){
        rh+='<div class="tl-grid-row" data-mid="'+m.id+'" data-ri="'+mi+'" style="width:'+gw+'px">';
        for(var h=H_START;h<H_END;h++){
          var x=(h-H_START)*S.zoom;
          rh+='<div class="tl-grid-line hour" style="left:'+x+'px"></div>';
          rh+='<div class="tl-grid-line" style="left:'+(x+S.zoom/2)+'px"></div>';
        }
        var mt=tasks.filter(function(t){return t.assigned_to===m.id});
        mt.forEach(function(t){
          var sd=t2d(t.scheduled_start_time), ed=t2d(t.scheduled_end_time);
          var left=(sd-H_START)*S.zoom, w=Math.max((ed-sd)*S.zoom,30);
          var col=taskColor(t), pc=PRIO_COLORS[t.priority]||'#575b6e';
          var dur=Math.round((ed-sd)*60), sel=S.selTask===t.id?' selected':'';
          var showM=w>120, showD=w>80;
          rh+='<div class="tl-task'+sel+'" data-tid="'+t.id+'" data-mid="'+m.id+'" style="left:'+left+'px;width:'+w+'px;background:'+col+'22;border-color:'+col+'44;">';
          rh+='<div class="tl-task-priority" style="background:'+pc+'"></div>';
          rh+='<div class="tl-task-content"><div class="tl-task-title" style="color:'+col+'">'+t.title+'</div>';
          if(showM) rh+='<div class="tl-task-meta">'+(t.client_name||t.project_name||'')+'</div>';
          rh+='</div>';
          if(showD) rh+='<div class="tl-task-duration">'+dur+'m</div>';
          rh+='</div>';
        });
        rh+='</div>';
      });

      if(S.members.length===0||tasks.length===0){
        rh='<div class="tl-empty"><div class="tl-empty-icon">&#128203;</div><div class="tl-empty-text">Keine geplanten Tasks</div><div class="tl-empty-sub">Tasks mit Zeitplan erscheinen hier automatisch</div></div>';
      }
      gr.innerHTML=rh;
    }

    var grid=$id('tlGrid'); if(grid) grid.style.width=gw+'px';
    renderNow();
  }

  function renderNow(){
    $$('.tl-now-line').forEach(function(e){e.parentNode.removeChild(e)});
    if(!sameDay(S.date,new Date())) return;
    if(S.view==='week'||S.view==='backlog') return;
    var now=new Date(), dec=now.getHours()+now.getMinutes()/60;
    if(dec<H_START||dec>H_END) return;
    var x=(dec-H_START)*S.zoom;
    var line=document.createElement('div');
    line.className='tl-now-line'; line.style.left=x+'px';
    var g=$id('tlGrid'); if(g) g.appendChild(line);
  }

  /* ── Render Week View ──────────────────────────────── */
  function renderWeek(){
    var dayV=$id('tlDayView'), weekV=$id('tlWeekView'), blV=$id('tlBacklogView');
    if(dayV) dayV.style.display='none';
    if(weekV) weekV.style.display='flex';
    if(blV)  blV.style.display='none';

    var mon=new Date(S.date); mon.setDate(mon.getDate()-((mon.getDay()+6)%7));
    var days=[],today=new Date();
    for(var i=0;i<7;i++){ var d=new Date(mon); d.setDate(mon.getDate()+i); days.push(d); }

    var hdr=$id('tlWeekHeader');
    if(hdr) hdr.innerHTML=days.map(function(d){
      var td=sameDay(d,today)?' today':'';
      return '<div class="tl-week-day-header'+td+'" data-date="'+toDS(d)+'"><span class="day-name">'+DAYS[d.getDay()]+'</span><span class="day-num">'+d.getDate()+'</span></div>';
    }).join('');

    var tasks=filtered(), grid=$id('tlWeekGrid');
    if(grid) grid.innerHTML=days.map(function(d){
      var ds=toDS(d);
      var dt=tasks.filter(function(t){return t.scheduled_date===ds && t.scheduled_start_time});
      dt.sort(function(a,b){return t2d(a.scheduled_start_time)-t2d(b.scheduled_start_time)});
      var html;
      if(!dt.length){
        html='<div style="color:#575b6e;font-size:11px;text-align:center;padding:16px;">—</div>';
      } else {
        html=dt.map(function(t){
          var col=taskColor(t);
          var st=t.scheduled_start_time?t.scheduled_start_time.slice(0,5):'';
          var en=t.scheduled_end_time?t.scheduled_end_time.slice(0,5):'';
          return '<div class="tl-week-task" data-tid="'+t.id+'" style="border-left-color:'+col+'"><div class="tl-week-task-title">'+t.title+'</div><div class="tl-week-task-time">'+st+(en?' – '+en:'')+'</div><div class="tl-week-task-assignee">'+(t.assignee_name||'')+'</div></div>';
        }).join('');
      }
      return '<div class="tl-week-column" data-date="'+ds+'">'+html+'</div>';
    }).join('');
  }

  /* ── Render Backlog ────────────────────────────────── */
  function renderBacklog(){
    var dayV=$id('tlDayView'), weekV=$id('tlWeekView'), blV=$id('tlBacklogView');
    if(dayV) dayV.style.display='none';
    if(weekV) weekV.style.display='none';
    if(blV)  blV.style.display='grid';

    var tasks=backlog();
    if(!blV) return;
    if(!tasks.length){
      blV.innerHTML='<div class="tl-empty" style="grid-column:1/-1"><div class="tl-empty-icon">&#10024;</div><div class="tl-empty-text">Backlog ist leer</div><div class="tl-empty-sub">Alle Tasks sind eingeplant</div></div>';
      return;
    }
    blV.innerHTML=tasks.map(function(t){
      var pc=PRIO_COLORS[t.priority]||'#575b6e';
      var cl=CAT_LABELS[t.category]||t.category||'';
      var cc=t.category?'cat-'+t.category:'cat-other';
      return '<div class="tl-backlog-card" data-tid="'+t.id+'"><div class="tl-backlog-priority" style="background:'+pc+'"></div><div class="tl-backlog-content"><div class="tl-backlog-title">'+t.title+'</div><div class="tl-backlog-detail">'+(cl?'<span class="tl-backlog-badge" style="background:'+CAT_COLORS[t.category||'other']+'">'+cl+'</span>':'')+(t.client_name?'<span>'+t.client_name+'</span>':'')+(t.estimated_minutes?'<span>'+t.estimated_minutes+'m</span>':'')+(t.assignee_name?'<span>'+t.assignee_name+'</span>':'')+'</div></div></div>';
    }).join('');
  }

  /* ── Master Render ─────────────────────────────────── */
  function render(){
    renderHeader(); renderFilters();
    if(S.view==='week') renderWeek();
    else if(S.view==='backlog') renderBacklog();
    else renderDay();
  }

  /* ── Drag ──────────────────────────────────────────── */
  function startDrag(el,e){
    var tid=el.getAttribute('data-tid');
    var task=null; S.tasks.forEach(function(t){if(t.id===tid)task=t});
    if(!task)return;
    var gw=$id('tlGridWrapper'); if(!gw)return;
    S.drag={
      tid:tid, task:task,
      sx:e.clientX, sy:e.clientY,
      oLeft:parseFloat(el.style.left),
      oMid:el.getAttribute('data-mid'),
      el:el,
      rows:$$('.tl-grid-row'),
      mrows:$$('.tl-member-row'),
      gRect:gw.getBoundingClientRect(),
      moved:false
    };
    el.classList.add('dragging');
  }

  function onMove(e){
    var d=S.drag; if(!d)return;
    var dx=e.clientX-d.sx, dy=e.clientY-d.sy;
    if(!d.moved && Math.abs(dx)<4 && Math.abs(dy)<4) return;
    d.moved=true;
    var snap=S.zoom/4;
    d.el.style.left=Math.max(0, d.oLeft+Math.round(dx/snap)*snap)+'px';
    var gw=$id('tlGridWrapper');
    var relY=e.clientY-d.gRect.top+(gw?gw.scrollTop:0)-40;
    var ri=Math.floor(relY/64);
    d.mrows.forEach(function(el){el.classList.remove('drop-target')});
    if(ri>=0&&ri<d.mrows.length){ d.mrows[ri].classList.add('drop-target'); d.hrow=ri; }
  }

  function onUp(){
    var d=S.drag; if(!d)return;
    d.el.classList.remove('dragging');
    d.mrows.forEach(function(el){el.classList.remove('drop-target')});
    if(d.moved){
      var nl=parseFloat(d.el.style.left);
      var sd=H_START+(nl/S.zoom);
      var os=t2d(d.task.scheduled_start_time), oe=t2d(d.task.scheduled_end_time);
      var dur=oe-os, nsd=Math.round(sd*4)/4, ned=nsd+dur;
      var ns=d2t(nsd), ne=d2t(ned);
      var nm=d.oMid;
      if(d.hrow!==undefined&&d.hrow>=0&&d.hrow<S.members.length) nm=S.members[d.hrow].id;
      wwWorkflow('updateTaskSchedule',{task_id:d.tid,new_start_time:ns,new_end_time:ne,new_assigned_to:nm!==d.oMid?nm:null});
      d.task.scheduled_start_time=ns+':00'; d.task.scheduled_end_time=ne+':00';
      if(nm!==d.oMid){ d.task.assigned_to=nm; S.members.forEach(function(m){if(m.id===nm)d.task.assignee_name=m.name}); }
      render();
    }
    S.drag=null;
  }

  /* ── Tooltip ───────────────────────────────────────── */
  var ttTimer;
  function showTip(el,e){
    var tid=el.getAttribute('data-tid');
    var task=null; S.tasks.forEach(function(t){if(t.id===tid)task=t});
    if(!task)return;
    var tip=$id('tlTooltip'); if(!tip)return;
    var tt=$id('tlTooltipTitle'), tb=$id('tlTooltipBody');
    if(tt) tt.textContent=task.title;
    var st=task.scheduled_start_time?task.scheduled_start_time.slice(0,5):'–';
    var en=task.scheduled_end_time?task.scheduled_end_time.slice(0,5):'–';
    var b='<div class="tl-tooltip-row"><strong>Zeit:</strong> '+st+' – '+en+'</div>';
    if(task.client_name) b+='<div class="tl-tooltip-row"><strong>Kunde:</strong> '+task.client_name+'</div>';
    if(task.project_name) b+='<div class="tl-tooltip-row"><strong>Projekt:</strong> '+task.project_name+'</div>';
    if(task.category) b+='<div class="tl-tooltip-row"><strong>Kategorie:</strong> '+(CAT_LABELS[task.category]||task.category)+'</div>';
    if(task.priority) b+='<div class="tl-tooltip-row"><strong>Priorit&#228;t:</strong> '+task.priority+'</div>';
    if(task.estimated_minutes) b+='<div class="tl-tooltip-row"><strong>Gesch&#228;tzt:</strong> '+task.estimated_minutes+' Min.</div>';
    if(tb) tb.innerHTML=b;
    // Position relative to root
    var rr=ROOT.getBoundingClientRect();
    tip.style.left=(e.clientX-rr.left+12)+'px';
    tip.style.top=(e.clientY-rr.top+12)+'px';
    tip.classList.add('visible');
  }
  function hideTip(){
    var tip=$id('tlTooltip'); if(tip) tip.classList.remove('visible');
  }

  /* ── Events ────────────────────────────────────────── */
  function initEvents(){
    // Tabs
    var tabs=$id('tlTabs');
    if(tabs) tabs.addEventListener('click',function(e){
      var t=e.target; while(t&&!t.classList.contains('tl-tab'))t=t.parentElement;
      if(!t)return;
      S.view=t.getAttribute('data-view'); wwSet('viewMode',S.view);
      var today=new Date();
      if(S.view==='today') S.date=new Date(today);
      else if(S.view==='tomorrow'){ S.date=new Date(today); S.date.setDate(today.getDate()+1); }
      wwSet('selectedDate',toDS(S.date)); render();
    });

    // Nav
    var prev=$id('tlPrevDay'), next=$id('tlNextDay');
    if(prev) prev.addEventListener('click',function(){ S.date=new Date(S.date); S.date.setDate(S.date.getDate()-(S.view==='week'?7:1)); wwSet('selectedDate',toDS(S.date)); render(); });
    if(next) next.addEventListener('click',function(){ S.date=new Date(S.date); S.date.setDate(S.date.getDate()+(S.view==='week'?7:1)); wwSet('selectedDate',toDS(S.date)); render(); });

    // Filters (delegated)
    var fl=$id('tlFilters');
    if(fl) fl.addEventListener('click',function(e){
      var p=e.target; while(p&&!p.classList.contains('tl-filter-pill'))p=p.parentElement;
      if(!p)return;
      S.filter=p.getAttribute('data-cat'); wwSet('filterCategory',S.filter); render();
    });

    // Zoom
    var zi=$id('tlZoomIn'), zo=$id('tlZoomOut');
    if(zi) zi.addEventListener('click',function(){ S.zoom=Math.min(S.zoom+20,240); wwSet('zoom',S.zoom); render(); });
    if(zo) zo.addEventListener('click',function(){ S.zoom=Math.max(S.zoom-20,60); wwSet('zoom',S.zoom); render(); });

    // Task mousedown (drag + select)
    ROOT.addEventListener('mousedown',function(e){
      var t=e.target; while(t&&!t.classList.contains('tl-task'))t=t.parentElement;
      if(!t)return;
      e.preventDefault();
      S.selTask=t.getAttribute('data-tid'); wwSet('selectedTaskId',S.selTask);
      startDrag(t,e);
      // Don't re-render here — it destroys the drag reference
      $$('.tl-task').forEach(function(el){el.classList.toggle('selected',el.getAttribute('data-tid')===S.selTask)});
    });

    // Dblclick
    ROOT.addEventListener('dblclick',function(e){
      var t=e.target;
      while(t && !t.getAttribute('data-tid')) t=t.parentElement;
      if(t && t.getAttribute('data-tid')) wwWorkflow('openTaskDetail',{task_id:t.getAttribute('data-tid')});
    });

    // Mouse move/up
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);

    // Tooltip
    ROOT.addEventListener('mouseover',function(e){
      var t=e.target; while(t&&!t.classList.contains('tl-task'))t=t.parentElement;
      if(t&&!S.drag) ttTimer=setTimeout(function(){showTip(t,e)},400);
    });
    ROOT.addEventListener('mouseout',function(e){
      var t=e.target; while(t&&!t.classList.contains('tl-task'))t=t.parentElement;
      if(t){clearTimeout(ttTimer);hideTip();}
    });

    // Week day click
    var wv=$id('tlWeekView');
    if(wv) wv.addEventListener('click',function(e){
      var h=e.target; while(h&&!h.classList.contains('tl-week-day-header'))h=h.parentElement;
      if(!h)return;
      S.date=parseDS(h.getAttribute('data-date')); S.view='today';
      wwSet('viewMode','today'); wwSet('selectedDate',h.getAttribute('data-date')); render();
    });

    // Scroll sync
    var gw=$id('tlGridWrapper'), ml=$id('tlMembers');
    if(gw&&ml){
      gw.addEventListener('scroll',function(){ml.scrollTop=gw.scrollTop});
      ml.addEventListener('scroll',function(){gw.scrollTop=ml.scrollTop});
    }
  }

  /* ── Watcher ───────────────────────────────────────── */
  function watch(){
    var last='';
    setInterval(function(){
      var ww=wwCollection('tasks');
      if(!ww)return;
      var h='';ww.forEach(function(t){h+=t.id+'|'+t.scheduled_start_time+'|'+t.assigned_to+'|'});
      if(h!==last){last=h;loadData();render();}
    },2000);
  }

  /* ── Init ──────────────────────────────────────────── */
  function boot(){
    ROOT = document.getElementById('tlRoot');
    if(!ROOT){
      // Try again — WeWeb might not have rendered yet
      setTimeout(boot, 200);
      return;
    }
    loadData();
    render();
    initEvents();
    watch();
    setInterval(renderNow, 60000);

    // Scroll to ~8am
    var gw=$id('tlGridWrapper');
    if(gw) gw.scrollLeft=Math.max(0,(8-H_START)*S.zoom-40);
  }

  // Boot with multiple fallbacks for WeWeb timing
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded',function(){setTimeout(boot,150)});
  } else {
    setTimeout(boot,150);
  }

  // Extra safety: also try on load
  window.addEventListener('load',function(){
    if(!ROOT) setTimeout(boot,300);
  });

})();
</script>
